apiVersion: v1
kind: ConfigMap
metadata:
  name: buildah-build-step
  namespace: kagenti-system
data:
  task-spec.yaml: |
    params:
      - name: DOCKERFILE
        type: string
        description: Name of Dockerfile or Containerfile
        default: "Dockerfile"
      - name: image
        type: string
        description: Destination image reference
      - name: SKIP_TLS_VERIFY
        type: string
        description: Skip TLS verification
        default: "false"
      - name: subfolder-path
        type: string
        description: Path to the subfolder
        default: "."
      - name: registry-secret
        type: string
        description: Name of the secret containing registry credentials
        default: "ghcr-secret"  
    workspaces:
      - name: source
    
    results:
      - name: IMAGE_URL
        description: URL of the built image
    
    steps:
      - name: build-image
        image: quay.io/buildah/stable:latest
        env:
          - name: STORAGE_DRIVER
            value: vfs
          - name: BUILDAH_ISOLATION
            value: chroot
          - name: XDG_RUNTIME_DIR
            value: /tmp/run
          - name: HOME
            value: /tmp/home
        script: |
          #!/bin/bash
          set -e
          
          cd $(workspaces.source.path)/$(params.subfolder-path)
          
          # Set up registry authentication
          export REGISTRY_AUTH_FILE=/root/.docker/config.json
          # Configure rootless buildah with vfs storage driver
          export BUILDAH_ISOLATION=chroot
          export STORAGE_DRIVER=vfs

          AUTH="/workspace/.docker/config.json" 

          buildah build \
            --file $(params.DOCKERFILE) \
            --tag $(params.image) \
            --tls-verify=$(params.SKIP_TLS_VERIFY) \
            --layers \
            --authfile $AUTH \
            .
          
          buildah push \
            --tls-verify=$(params.SKIP_TLS_VERIFY) \
            --authfile $AUTH \
            $(params.image)
          
          echo -n "$(params.image)" > $(results.IMAGE_URL.path)
        securityContext:
          runAsUser: 1000
          runAsNonRoot: true
          capabilities:
            add:
             - SETUID
             - SETGID
        volumeMounts:
          - name: varlibcontainers
            mountPath: /var/lib/containers
          - name: run
            mountPath: /tmp/run
          - name: homedir
            mountPath: /tmp/home        
          - name: docker-config
            mountPath: /workspace/.docker
            readOnly: true
    
    volumes:
      - name: varlibcontainers
        emptyDir: {}
      - name: run
        emptyDir: {}
      - name: homedir
        emptyDir: {}    
      - name: docker-config
        secret:
          secretName: $(params.registry-secret)
          items:
          - key: .dockerconfigjson
            path: config.json  